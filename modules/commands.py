from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, Message, InlineKeyboardButton, CallbackQuery
from aiogram.dispatcher.filters import IDFilter
import subprocess
import os

from modules.config import dp, USER_ID, bot, save_reports

@dp.message_handler(IDFilter(USER_ID), commands=['start'])
async def start(message: Message):
    await message.reply('Hi! I\'m your personal assistant for the basic pentest. To see my capabilities, write /help')

@dp.message_handler(IDFilter(USER_ID), commands=['help'])
async def help_command(message: Message):
    
    commands = [
        '/start - start work with bot',
        '/help - list of available commands',
        '/settings - bot settings',
        '/select_script - select a script or file to download'
    ]

    help_message = 'Available commands:\n'
    help_message += '\n'.join(commands)
    help_message += '\nAlso you can send me cmd linux commands and i will run them'

    await message.reply(help_message)
    
@dp.message_handler(IDFilter(USER_ID), commands=['settings'])
async def settings(message: Message):
    global save_reports

    keyboard = InlineKeyboardMarkup(row_width=1)
    msg = 'Saving reports to file: ✅' if save_reports else 'Saving reports to file: ❌'
    report_button = InlineKeyboardButton(msg, callback_data='/save_reports')
    script_button = InlineKeyboardButton('Select useful file', callback_data='/select_script')
    keyboard.add(report_button, script_button)

    await message.reply('Choose what do you want to configure:', reply_markup=keyboard)

@dp.callback_query_handler(lambda c: c.data == '/save_reports')
async def handle_save_reports_callback(query: CallbackQuery):
    global save_reports
    save_reports = not save_reports

    if save_reports:
        await query.message.reply('✅ Saving reports to file is enabled.')
    else:
        await query.message.reply('❌ Saving reports to file is disabled.')

@dp.callback_query_handler(lambda c: c.data == '/select_script')
async def handle_select_script_callback(query: CallbackQuery):
    keyboard = InlineKeyboardMarkup(row_width=1)
    script1_button = InlineKeyboardButton('Linpeas', callback_data='linpeas.sh')
    keyboard.add(script1_button)

    await query.message.reply('Select a script or file:', reply_markup=keyboard)


@dp.callback_query_handler(IDFilter(USER_ID))
async def handle_callback_query(query: CallbackQuery):
    script_path = '/root/pocketPentester/scripts_n_files/' + query.data
   
    if script_path:
        with open(script_path, 'rb') as file:
            await bot.send_document(query.from_user.id, file)
    else:
        await bot.answer_callback_query(query.id, text='Invalid selection')

@dp.message_handler(IDFilter(USER_ID), content_types=['text'])
async def main(message: Message):
    command = message.text 
    try:
        if command.startswith('cd'):
            path2move = command.strip('cd ')
            
            if os.path.exists(path2move):
                os.chdir(path2move)
                await bot.send_message(message.chat.id, 'Directory changed to'+path2move)
            else:
                await bot.send_message(message.chat.id, 'Cant change directory to'+path2move)
        else:
            result = subprocess.run(command.split(' '), capture_output=True)
            await bot.send_message(message.chat.id, result.stdout.decode())
    except:
        await bot.send_message(message.chat.id, 'Invalid input')   